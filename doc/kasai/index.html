<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Animal Communication</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Animation Styles -->
    <style>
        @keyframes bounce-fast {
            0%, 100% { transform: translateY(0) scale(1.1); }
            50% { transform: translateY(-20px) scale(0.9); }
        }
        .animate-bounce-fast {
            animation: bounce-fast 0.4s infinite;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (SVG Components) ---
        const IconUtensils = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
        );
        const IconSparkles = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
        );
        const IconAlertCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const IconRefreshCw = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        );
        const IconSend = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        );
        const IconType = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg>
        );
        const IconHand = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>
        );
        const IconVolume2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        );
        const IconX = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const IconZoomIn = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></svg>
        );
        const IconKey = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>
        );


        // --- AUDIO SYSTEM ---
        const playSystemSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                const now = ctx.currentTime;

                switch (type) {
                    case 'pop':
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(800, now);
                        osc.frequency.exponentialRampToValueAtTime(400, now + 0.08);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
                        osc.start(now);
                        osc.stop(now + 0.1);
                        break;
                    case 'start':
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(440, now);
                        osc.frequency.linearRampToValueAtTime(880, now + 0.1);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.3);
                        osc.start(now);
                        osc.stop(now + 0.3);
                        break;
                    case 'chew':
                        const bufferSize = ctx.sampleRate * 0.1; 
                        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                        const noise = ctx.createBufferSource();
                        noise.buffer = buffer;
                        const noiseGain = ctx.createGain();
                        const filter = ctx.createBiquadFilter();
                        filter.type = 'lowpass';
                        filter.frequency.value = 1000;
                        noise.connect(filter);
                        filter.connect(noiseGain);
                        noiseGain.connect(ctx.destination);
                        noiseGain.gain.setValueAtTime(0.05, now);
                        noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                        noise.start(now);
                        break;
                    case 'fanfare':
                        [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                            const o = ctx.createOscillator();
                            const g = ctx.createGain();
                            o.connect(g);
                            g.connect(ctx.destination);
                            o.type = 'triangle';
                            o.frequency.value = f;
                            g.gain.setValueAtTime(0, now);
                            g.gain.linearRampToValueAtTime(0.05, now + 0.05 + (i*0.02));
                            g.gain.exponentialRampToValueAtTime(0.001, now + 2.0);
                            o.start(now);
                            o.stop(now + 2.0);
                        });
                        break;
                    case 'cancel':
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(300, now);
                        osc.frequency.linearRampToValueAtTime(150, now + 0.2);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.2);
                        osc.start(now);
                        osc.stop(now + 0.2);
                        break;
                }
            } catch (e) { console.error("Audio failed", e); }
        };

        // --- GAME LOGIC ---

        const ANIMALS = [
            { id: 1, type: 'lion', name: '„É©„Ç§„Ç™„É≥„ÅÆ„É¨„Ç™', personality: '„Éó„É©„Ç§„Éâ„ÅåÈ´ò„ÅÑ„Åë„Å©„ÅäËÇâ„Å´ÁõÆ„Åå„Å™„ÅÑ„ÄÇÁéãÊßòÂè£Ë™ø„ÄÇ', icon: 'ü¶Å', color: 'bg-yellow-100 border-yellow-400 text-yellow-800' },
            { id: 2, type: 'penguin', name: '„Éö„É≥„ÇÆ„É≥„ÅÆ„Éö„É≥„Éö„É≥', personality: '„ÇØ„Éº„É´„Å†„Åë„Å©È≠ö„ÇíË¶ã„Çã„Å®ÁêÜÊÄß„ÇíÂ§±„ÅÜ„ÄÇÂ≠ê‰æõ„Å£„ÅΩ„ÅÑ„ÄÇ', icon: 'üêß', color: 'bg-blue-100 border-blue-400 text-blue-800' },
            { id: 3, type: 'panda', name: '„Éë„É≥„ÉÄ„ÅÆ„Éù„Éù', personality: '„ÅÆ„Çì„Å≥„ÇäÂ±ã„Åß„Ç∞„É´„É°„ÄÇÁ¨π‰ª•Â§ñ„Å´„ÅØÂé≥„Åó„ÅÑ„ÄÇÈñ¢Ë•øÂºÅ„ÄÇ', icon: 'üêº', color: 'bg-slate-100 border-slate-400 text-slate-800' },
            { id: 4, type: 'capybara', name: '„Ç´„Éî„Éê„É©„Åï„Çì', personality: '‰Ωï„Çí„Åï„Çå„Å¶„ÇÇÂãï„Åò„Å™„ÅÑ„Åå„ÄÅÊ∏©Ê≥â„Å®Ëçâ„ÅåÂ•Ω„Åç„ÄÇ„ÅÆ„Åª„Åª„ÇìÂè£Ë™ø„ÄÇ', icon: 'ü¶´', color: 'bg-green-100 border-green-400 text-green-800' },
        ];

        const ALL_FOODS = [
            { name: '‰∏äÁ≠â„Å™„ÅäËÇâ', type: 'success', icon: 'üçñ' }, { name: 'Êñ∞ÈÆÆ„Å™È≠ö', type: 'success', icon: 'üêü' }, { name: 'Áîò„ÅÑ„É™„É≥„Ç¥', type: 'success', icon: 'üçé' }, { name: 'È´òÁ¥ö„Å™ÂØøÂè∏', type: 'success', icon: 'üç£' },
            { name: '„Åü„Å†„ÅÆÈõëËçâ', type: 'fail', icon: 'üåø' }, { name: 'ÊûØ„ÇåËëâ', type: 'fail', icon: 'üçÇ' }, { name: 'Áü≥„Åì„Çç', type: 'fail', icon: 'ü™®' }, { name: 'Á©∫„ÅçÁº∂', type: 'fail', icon: 'ü•´' },
            { name: 'Âè§„Çø„Ç§„É§', type: 'joke', icon: 'üõû' }, { name: 'Ê±ö„Çå„ÅüÈù¥‰∏ã', type: 'joke', icon: 'üß¶' }, { name: '„Ç≤„Éº„É†Ê©ü', type: 'joke', icon: 'üéÆ' }, { name: 'ÂÆøÈ°å', type: 'joke', icon: 'üìù' },
            { name: 'ÊøÄËæõ„Ç´„É¨„Éº', type: 'surprise', icon: 'üçõ' }, { name: '„Çè„Åï„Å≥ÂØøÂè∏', type: 'surprise', icon: 'ü§¢' }, { name: 'ËôπËâ≤„ÅÆÈ£¥', type: 'surprise', icon: 'üç≠' }, { name: 'ÂîêËæõÂ≠ê', type: 'surprise', icon: 'üå∂Ô∏è' },
        ];

        function App() {
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
            const [phase, setPhase] = useState('START');
            const [selectedAnimal, setSelectedAnimal] = useState(null);
            const [selectedFood, setSelectedFood] = useState('');
            const [customFood, setCustomFood] = useState('');
            const [reactionText, setReactionText] = useState('');
            const [reactionImage, setReactionImage] = useState(null);
            const [loadingMessage, setLoadingMessage] = useState('„É¢„Ç∞„É¢„Ç∞...');
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [error, setError] = useState(null);
            const [isImageModalOpen, setIsImageModalOpen] = useState(false);
            const [currentOptions, setCurrentOptions] = useState([]);
            const [isChewing, setIsChewing] = useState(false);
            
            const isCancelledRef = useRef(false);

            useEffect(() => {
                let interval;
                if (isChewing) interval = setInterval(() => playSystemSound('chew'), 600);
                return () => clearInterval(interval);
            }, [isChewing]);

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('gemini_api_key', key);
            };

            const pickRandomFoods = () => {
                const types = ['success', 'fail', 'joke', 'surprise'];
                const selected = types.map(t => {
                    const foods = ALL_FOODS.filter(f => f.type === t);
                    return foods[Math.floor(Math.random() * foods.length)];
                });
                setCurrentOptions(selected.sort(() => 0.5 - Math.random()));
            };

            // „É¢„ÉÉ„ÇØÔºö„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàê
            const generateMockText = (animal, food) => {
                const foodData = ALL_FOODS.find(f => f.name === food);
                const foodType = foodData?.type || 'surprise';
                
                const reactions = {
                    lion: {
                        success: ['„Çè„ÅÅÔºÅ„Åì„ÅÆ„ÅäËÇâ„ÅØÊúÄÈ´ò„Åò„ÇÉÔºÅÁéãÊßò„Å´„Åµ„Åï„Çè„Åó„ÅÑÂë≥„Å†„Å™ÔºÅ', '„ÅÜ„Åæ„ÅÑÔºÅ„Åì„Çå„ÅûÁéãËÄÖ„ÅÆ„Åî„Å°„Åù„ÅÜ„Åò„ÇÉÔºÅ', '„Åì„ÅÆÂë≥...„Åæ„Åï„Å´ÁéãËÄÖ„ÅÆËàå„Å´„Åµ„Åï„Çè„Åó„ÅÑÔºÅ'],
                        fail: ['„Å™„ÄÅ„Å™„Çì„Å†„Åì„Çå„ÅØ...ÔºÅÁéãÊßò„Å´„Åì„Çì„Å™„ÇÇ„ÅÆ„ÇíÔºÅ', '„Åì„Çå„ÅØ...Â§±Á§º„Åò„ÇÉ„Å™ÔºÅ„ÇÇ„Å£„Å®ËâØ„ÅÑ„ÇÇ„ÅÆ„ÇíÔºÅ', '„Åµ„Çì„ÄÅ„Åì„Çì„Å™„ÇÇ„ÅÆ„Åß„ÅØÊ∫ÄË∂≥„Åß„Åç„Å¨ÔºÅ'],
                        joke: ['...„Åì„Çå„ÅØ‰Ωï„Åò„ÇÉÔºü„Åæ„Åï„Åã„Ç®„Çµ„Åß„ÅØ„Å™„ÅÑ„Å™Ôºü', 'ÁéãÊßò„Çí„Åã„Çâ„Åã„ÅÜ„Å§„ÇÇ„Çä„ÅãÔºü', '„Åµ„Å£„ÄÅÈù¢ÁôΩ„ÅÑ„Åì„Å®„Çí...'],
                        surprise: ['„ÇÄ„ÇÄ„Å£ÔºÅ„Åì„Çå„ÅØ...‰∫àÊÉ≥Â§ñ„Åò„ÇÉÔºÅ', '„Å™„ÄÅ„Å™„Çì„Å†„Åì„ÅÆÂë≥„ÅØ...ÔºÅ', '„Åì„Çå„ÅØ...ÊÑèÂ§ñ„Å™Âë≥„Åò„ÇÉ„Å™ÔºÅ']
                    },
                    penguin: {
                        success: ['„Çè„Éº„ÅÑÔºÅ„Åì„ÅÆÈ≠ö„ÄÅ„ÇÅ„Å£„Å°„ÇÉ„Åä„ÅÑ„Åó„ÅÑÔºÅ', '„ÇÑ„Å£„Åü„ÉºÔºÅÊúÄÈ´ò„ÅÆÈ≠ö„Å†„Çà„ÄúÔºÅ', '„ÅÜ„Åæ„ÅÑÔºÅ„ÇÇ„Å£„Å®È£ü„Åπ„Åü„ÅÑ„Å™ÔºÅ'],
                        fail: ['„Åà„Éº...„Åì„Çå„ÄÅÈ£ü„Åπ„Çâ„Çå„Å™„ÅÑ„Çà...', '„ÅÜ„Çè„ÅÅ„ÄÅ„Åæ„Åö„ÅÑ...', '„Åì„Çå„Åò„ÇÉ„ÅÇ„ÉÄ„É°„Å†„Çà„Äú'],
                        joke: ['„ÅàÔºü„Åì„Çå„ÄÅÈ£ü„ÅπÁâ©„Åò„ÇÉ„Å™„ÅÑ„Çà„Å≠Ôºü', '„Å™„Å´„Åì„Çå„ÄúÔºü„Åä„ÇÇ„Åó„Çç„ÅÑÔºÅ', '„ÅØÔºü„Åì„Çå‰ΩïÔºü'],
                        surprise: ['„Çè„ÅÇÔºÅ„Å≥„Å£„Åè„Çä„Åó„ÅüÔºÅ', '„Åà„Åà„ÅàÔºÅÔºü„Åì„Çå„Å™„Å´Ôºü', '„ÅÜ„Çè„ÅÅÔºÅ‰∫àÊÉ≥Â§ñÔºÅ']
                    },
                    panda: {
                        success: ['„Åä„Åä„ÄÅ„Åì„Çå„ÅØ„ÅÜ„Åæ„ÅÑ„Åß„ÄúÔºÅ', '„Åà„ÅàÂë≥„ÇÑ„Å™„ÅÅÔºÅ', '„Åì„Çå„ÅØ„Åà„Åà„ÇèÔºÅ'],
                        fail: ['„ÅÇ„Åã„Çì„ÄÅ„Åì„Çå„ÅØ„ÅÇ„Åã„Çì„Çè...', '„ÅÜ„Éº„Çì„ÄÅ„Åì„Çå„ÅØ„Å°„Çá„Å£„Å®...', '„Åì„Çå„ÅØ...ÂæÆÂ¶ô„ÇÑ„Å™'],
                        joke: ['„ÅØÔºü„Åì„Çå‰ΩïÔºüÈ£ü„ÅπÁâ©„Å°„ÇÉ„ÅÜ„ÇÑ„ÇçÔºü', '„Åà„ÅàÔºü„Åì„Çå„ÄÅ„Ç®„Çµ„Å°„ÇÉ„ÅÜ„Åß„Äú', '„Å™„Å´„Åì„Çå„ÄúÔºü„Åä„ÇÇ„Çç„ÅÑ„Å™'],
                        surprise: ['„Åä„ÅäÔºÅ„Åì„Çå„ÅØ„Å≥„Å£„Åè„Çä„ÇÑÔºÅ', '„Åà„ÅàÔºÅÔºü‰∫àÊÉ≥Â§ñ„ÇÑ„Å™ÔºÅ', '„Çè„ÅÇ„ÄÅ„Åì„Çå„ÅØÊÑèÂ§ñ„ÇÑÔºÅ']
                    },
                    capybara: {
                        success: ['„ÅÇ„ÅÇ„ÄÅ„Åì„Çå„ÅØ„ÅÑ„ÅÑ„Å≠„Åá...„ÅÆ„Çì„Å≥„ÇäÈ£ü„Åπ„Çâ„Çå„Çã', '„ÅÜ„Çì„ÄÅ„Åæ„ÅÇ„Åæ„ÅÇ„ÅÑ„ÅÑÊÑü„Åò', '„ÅÆ„Åª„Åª„Çì...„Åä„ÅÑ„Åó„ÅÑ„Å≠'],
                        fail: ['„Åæ„ÅÇ„ÄÅÂà•„Å´„ÅÑ„ÅÑ„Åë„Å©...', '„ÅÜ„Éº„Çì„ÄÅ„Åæ„ÅÇ...', '„ÅÆ„Åª„Åª„Çì...„Åæ„ÅÇ„ÅÑ„ÅÑ„Åã'],
                        joke: ['„ÅÆ„Åª„Åª„Çì...„Åì„Çå„ÄÅÈ£ü„ÅπÁâ©Ôºü', '„ÅÇ„ÅÇ„ÄÅ„Åæ„ÅÇ...Èù¢ÁôΩ„ÅÑ„Å≠', '„ÅÆ„Åª„Åª„Çì...Â§â„Çè„Å£„Å¶„Çã„Å≠'],
                        surprise: ['„Åä„ÇÑÔºü„Åì„Çå„ÅØÊÑèÂ§ñ„Å†„Å≠', '„ÅÆ„Åª„Åª„Çì...‰∫àÊÉ≥Â§ñ„Å†„Å™', '„ÅÇ„Çâ„ÄÅ„Åì„Çå„ÅØÈù¢ÁôΩ„ÅÑ']
                    }
                };

                const animalReactions = reactions[animal.type] || reactions.lion;
                const typeReactions = animalReactions[foodType] || animalReactions.surprise;
                return typeReactions[Math.floor(Math.random() * typeReactions.length)];
            };

            // „É¢„ÉÉ„ÇØÔºöÁîªÂÉèÁîüÊàêÔºàSVGÔºâ
            const generateMockImage = (animal, food) => {
                const foodIcon = ALL_FOODS.find(f => f.name === food)?.icon || 'üçΩÔ∏è';
                const animalIcon = animal.icon;
                
                const svg = `
                    <svg width="512" height="512" xmlns="http://www.w3.org/2000/svg">
                        <rect width="512" height="512" fill="#ffffff"/>
                        <text x="256" y="200" font-size="120" text-anchor="middle">${animalIcon}</text>
                        <text x="256" y="320" font-size="80" text-anchor="middle">${foodIcon}</text>
                        <text x="256" y="400" font-size="40" text-anchor="middle" fill="#666">${animal.name}</text>
                        <text x="256" y="450" font-size="30" text-anchor="middle" fill="#999">${food}</text>
                    </svg>
                `.trim();
                return `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
            };

            const startGame = () => {
                // „É¢„ÉÉ„ÇØ„É¢„Éº„ÉâÔºöAPI„Ç≠„Éº„Å™„Åó„Åß„ÇÇÂãï‰Ωú
                playSystemSound('start');
                setSelectedAnimal(ANIMALS[Math.floor(Math.random() * ANIMALS.length)]);
                setPhase('ENCOUNTER');
                setError(null);
            };

            const handleFoodSelect = (foodName) => {
                playSystemSound('start');
                setSelectedFood(foodName);
                processFeeding(foodName);
            };

            const handleCustomFoodSubmit = (e) => {
                e.preventDefault();
                if (!customFood.trim()) return;
                playSystemSound('start');
                setSelectedFood(customFood);
                processFeeding(customFood);
            };

            const processFeeding = async (food) => {
                isCancelledRef.current = false;
                setPhase('PROCESSING');
                setIsChewing(true);
                setLoadingProgress(10);
                setLoadingMessage('„Åè„Çì„Åè„Çì...ÂåÇ„ÅÑ„ÇíÂóÖ„ÅÑ„Åß„ÅÑ„Çã„Çà');
                setError(null);

                try {
                    // „É¢„ÉÉ„ÇØ„É¢„Éº„ÉâÔºöAPI„Ç≠„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØAPI„Çí‰ΩøÁî®„ÄÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„É¢„ÉÉ„ÇØ„Çí‰ΩøÁî®
                    const useMock = !apiKey;
                    
                    let text, imageUrl;

                    if (useMock) {
                        // „É¢„ÉÉ„ÇØÔºö„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàêÔºàÈÅÖÂª∂„ÇíÂÖ•„Çå„Å¶„É™„Ç¢„É´„Å´Ôºâ
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        if (isCancelledRef.current) return;
                        
                        setLoadingProgress(50);
                        setLoadingMessage('„É¢„Ç∞„É¢„Ç∞...„Å©„Çì„Å™Âë≥„Åã„Å™Ôºü');
                        text = generateMockText(selectedAnimal, food);
                        setReactionText(text);

                        // „É¢„ÉÉ„ÇØÔºöÁîªÂÉèÁîüÊàêÔºàÈÅÖÂª∂„ÇíÂÖ•„Çå„Å¶„É™„Ç¢„É´„Å´Ôºâ
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        if (isCancelledRef.current) return;
                        
                        imageUrl = generateMockImage(selectedAnimal, food);
                    } else {
                        // ÂÆüÈöõ„ÅÆAPIÂëº„Å≥Âá∫„Åó
                        // 1. Text Generation
                        const textPrompt = `„ÅÇ„Å™„Åü„ÅØ„Äå${selectedAnimal.name}„Äç„Å®„ÅÑ„ÅÜÂãïÁâ©„Åß„Åô„ÄÇÊÄßÊ†º„ÅØ„Äå${selectedAnimal.personality}„Äç„ÄÇ‰ªä„Äå${food}„Äç„ÇíÈ£ü„Åπ„Åæ„Åó„Åü„ÄÇÂ≠ê‰æõÂêë„Åë„ÅÆÂè£Ë™ø„Åß„ÄÅÂë≥„ÇÑÈ£üÊÑü„ÇíÊÉ≥ÂÉèÂäõË±ä„Åã„Å´„ÄÅÂ•Ω„ÅçÂ´å„ÅÑ„Çí„ÅØ„Å£„Åç„Çä„Åï„Åõ„ÄÅ60ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÊÑüÊÉ≥„ÇíË®Ä„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                        
                        const textRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: textPrompt }] }] })
                        });
                        
                        if (!textRes.ok) throw new Error('Text Gen Failed');
                        const textData = await textRes.json();
                        text = textData.candidates?.[0]?.content?.parts?.[0]?.text || "Ôºà„É¢„Ç∞„É¢„Ç∞...Ë®ÄËëâ„ÅåÂá∫„Å™„ÅÑÔºÅÔºâ";

                        if (isCancelledRef.current) return;
                        setLoadingProgress(50);
                        setLoadingMessage('„É¢„Ç∞„É¢„Ç∞...„Å©„Çì„Å™Âë≥„Åã„Å™Ôºü');
                        setReactionText(text);

                        // 2. Image Generation
                        const imagePrompt = `A funny cartoon illustration of a cute ${selectedAnimal.type} eating "${food}". The animal looks: ${text.includes('Ëæõ') ? 'fire breathing' : text.includes('ÁæéÂë≥') ? 'happy' : 'surprised'}. Style: 3D Pixar style, cute, white background.`;
                        
                        const imgRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instances: [{ prompt: imagePrompt }], parameters: { sampleCount: 1 } })
                        });

                        if (!imgRes.ok) throw new Error('Image Gen Failed');
                        const imgData = await imgRes.json();
                        
                        if (!imgData.predictions?.[0]?.bytesBase64Encoded) throw new Error('No Image Data');
                        imageUrl = `data:image/png;base64,${imgData.predictions[0].bytesBase64Encoded}`;
                    }

                    if (isCancelledRef.current) return;
                    setReactionImage(imageUrl);
                    setLoadingProgress(100);
                    setLoadingMessage('„Ç¥„ÉÉ„ÇØ„É≥ÔºÅ');
                    
                    setTimeout(() => {
                        if (!isCancelledRef.current) {
                            setIsChewing(false);
                            setPhase('RESULT');
                            playSystemSound('fanfare');
                        }
                    }, 800);

                } catch (e) {
                    console.error(e);
                    if (!isCancelledRef.current) {
                        setIsChewing(false);
                        setPhase('FEEDING');
                        setError("„Ç®„É©„ÉºÔºÅ‰∏çÈÅ©Âàá„Å™Ë®ÄËëâ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅAPI„Ç≠„Éº„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ");
                        playSystemSound('cancel');
                    }
                }
            };

            // --- RENDER ---

            // API Key Modal
            const [showKeyModal, setShowKeyModal] = useState(false);
            if (showKeyModal) {
                return (
                    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                        <div className="bg-white p-6 rounded-2xl max-w-md w-full">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><IconKey className="w-5 h-5"/> API„Ç≠„ÉºË®≠ÂÆö</h2>
                            <p className="text-sm text-slate-500 mb-4">Google AI Studio (Gemini API) „ÅÆ„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                            <input 
                                type="password" 
                                value={apiKey} 
                                onChange={(e) => saveApiKey(e.target.value)}
                                className="w-full border p-2 rounded mb-4 font-mono"
                                placeholder="AIzaSy..."
                            />
                            <button onClick={() => setShowKeyModal(false)} className="w-full bg-blue-500 text-white py-2 rounded-lg font-bold">Èñâ„Åò„Çã</button>
                        </div>
                    </div>
                );
            }

            if (phase === 'START') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-sky-300 to-green-200 flex flex-col items-center justify-center p-4 font-sans text-slate-800">
                        <button onClick={() => setShowKeyModal(true)} className="absolute top-4 right-4 bg-white/50 p-2 rounded-full hover:bg-white text-slate-600"><IconKey className="w-5 h-5"/></button>
                        <div className="bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-4 border-white">
                            <div className="mb-6 flex justify-center space-x-2">
                                <span className="text-6xl animate-bounce" style={{ animationDelay: '0s' }}>ü¶Å</span>
                                <span className="text-6xl animate-bounce" style={{ animationDelay: '0.1s' }}>üêº</span>
                                <span className="text-6xl animate-bounce" style={{ animationDelay: '0.2s' }}>üêß</span>
                            </div>
                            <h1 className="text-3xl font-black text-orange-500 mb-2 drop-shadow-md">AI„Ç¢„Éã„Éû„É´<br/>„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥</h1>
                            <p className="text-slate-600 mb-8 font-bold">„ÅÇ„Å™„Åü„ÅÆ„Ç®„Çµ„ÅßÂãïÁâ©„ÅåÂ§â„Çè„ÇãÔºÅÔºü</p>
                            <button onClick={startGame} className="w-full bg-orange-500 hover:bg-orange-600 text-white text-2xl font-bold py-4 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-2 mb-4">
                                <IconUtensils className="w-8 h-8" /> „ÅÇ„Åù„Çì„Åß„Åø„Çã
                            </button>
                        </div>
                    </div>
                );
            }

            // Other phases (ENCOUNTER, FEEDING, PROCESSING, RESULT) logic is largely same but simplified for HTML
            if (phase === 'ENCOUNTER') {
                return (
                    <div className="min-h-screen bg-amber-50 flex flex-col items-center justify-center p-4">
                        <div className={`max-w-md w-full bg-white rounded-3xl shadow-xl overflow-hidden border-4 ${selectedAnimal.color.split(' ')[1].replace('bg-', 'border-')}`}>
                            <div className={`${selectedAnimal.color} p-6 text-center`}>
                                <h2 className="text-2xl font-bold mb-2">ÈáéÁîü„ÅÆ {selectedAnimal.name} „Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ</h2>
                                <div className="text-9xl my-4 animate-pulse">{selectedAnimal.icon}</div>
                                <p className="font-bold bg-white/50 inline-block px-4 py-1 rounded-full">{selectedAnimal.personality}</p>
                            </div>
                            <div className="p-6 text-center">
                                <p className="text-lg text-slate-700 mb-6">„Äå„ÅäËÖπ„Åå„Åô„ÅÑ„Åü„Å™„ÅÅ...‰Ωï„Åã„Åä„ÅÑ„Åó„ÅÑ„ÇÇ„ÅÆÊåÅ„Å£„Å¶„ÇãÔºü„Äç</p>
                                <button onClick={() => { playSystemSound('pop'); pickRandomFoods(); setPhase('FEEDING'); }} className="w-full bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 rounded-2xl shadow-md transition transform hover:scale-105">
                                    „Ç®„Çµ„Çí„ÅÇ„Åí„ÇãÔºÅ
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (phase === 'FEEDING') {
                return (
                    <div className="min-h-screen bg-sky-100 flex flex-col items-center p-4 pt-10">
                        <div className="max-w-md w-full space-y-6">
                            {error && (
                                <div className="bg-red-100 border-2 border-red-400 text-red-700 px-4 py-3 rounded-2xl flex items-center gap-3 animate-pulse">
                                    <IconAlertCircle className="w-6 h-6 flex-shrink-0" />
                                    <span className="font-bold text-sm">{error}</span>
                                </div>
                            )}
                            <div className="flex items-center justify-center gap-4 bg-white p-4 rounded-2xl shadow-md">
                                <div className="font-bold text-lg text-slate-700">{selectedAnimal.name}</div>
                                <div className="text-6xl">{selectedAnimal.icon}</div>
                                <div className="bg-slate-100 p-3 rounded-xl relative">
                                    <div className="absolute left-0 top-1/2 -translate-x-2 -translate-y-1/2 w-4 h-4 bg-slate-100 rotate-45"></div>
                                    <p className="font-bold text-slate-700">„ÄåÊó©„Åè„Å°„Çá„ÅÜ„Å†„ÅÑ„Çà„ÄúÔºÅ„Äç</p>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl shadow-lg">
                                <h3 className="text-center font-bold text-slate-500 mb-4 flex items-center justify-center gap-2"><IconSparkles className="w-5 h-5 text-yellow-500" /> ÊåÅ„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„Åã„ÇâÈÅ∏„Å∂</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {currentOptions.map((food, idx) => (
                                        <button key={idx} onClick={() => handleFoodSelect(food.name)} className="bg-slate-50 hover:bg-orange-50 border-2 border-slate-200 hover:border-orange-300 p-3 rounded-xl flex flex-col items-center transition">
                                            <span className="text-3xl mb-1">{food.icon}</span>
                                            <span className="font-bold text-sm text-slate-700">{food.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl shadow-lg border-2 border-purple-100">
                                <h3 className="text-center font-bold text-purple-600 mb-4 flex items-center justify-center gap-2"><IconType className="w-5 h-5" /> Ëá™Áî±„Å´Êõ∏„ÅÑ„Å¶„ÅÇ„Åí„Çã</h3>
                                <form onSubmit={handleCustomFoodSubmit} className="space-y-3">
                                    <input type="text" maxLength={20} placeholder="‰æãÔºöËôπËâ≤„ÅÆ„Ç≠„É£„É≥„Éá„Ç£..." value={customFood} onChange={(e) => setCustomFood(e.target.value)} className="w-full bg-slate-100 border-none rounded-xl p-4 font-bold text-lg focus:ring-2 focus:ring-purple-400 outline-none" />
                                    <button type="submit" disabled={!customFood.trim()} className="w-full bg-purple-500 disabled:bg-slate-300 hover:bg-purple-600 text-white font-bold py-3 rounded-xl shadow-md transition flex items-center justify-center gap-2">
                                        <IconSend className="w-5 h-5" /> „Åì„Çå„Å´„Åô„ÇãÔºÅ
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            if (phase === 'PROCESSING') {
                return (
                    <div className="min-h-screen bg-orange-50 flex flex-col items-center justify-center p-4">
                        <div className="text-center max-w-sm w-full">
                            <div className="relative w-48 h-48 mx-auto mb-8 flex items-center justify-center">
                                <div className="absolute inset-0 bg-white rounded-full shadow-xl animate-pulse"></div>
                                <div className={`text-8xl z-10 transition-transform duration-200 ${isChewing ? 'animate-bounce-fast' : ''}`}>{selectedAnimal.icon}</div>
                                <div className="absolute top-0 right-0 text-4xl animate-ping opacity-75">‚ú®</div>
                            </div>
                            <h2 className="text-2xl font-black text-orange-600 mb-2 animate-bounce">{loadingMessage}</h2>
                            <div className="w-full bg-orange-200 rounded-full h-4 overflow-hidden mb-4">
                                <div className="bg-orange-500 h-full transition-all duration-500 ease-out" style={{ width: `${loadingProgress}%` }}></div>
                            </div>
                            <div className="flex items-center justify-center gap-2 mt-4 text-orange-400/50"><IconVolume2 className="w-4 h-4 animate-pulse" /></div>
                            <button onClick={() => { isCancelledRef.current = true; setIsChewing(false); setPhase('FEEDING'); playSystemSound('cancel'); }} className="mt-8 bg-red-400 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-full shadow-md transition transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2 mx-auto w-full max-w-xs">
                                <IconHand className="w-5 h-5" /> „Ç®„Çµ„ÇíÂèñ„Çä‰∏ä„Åí„Çã
                            </button>
                        </div>
                    </div>
                );
            }

            if (phase === 'RESULT') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-yellow-100 to-orange-100 flex flex-col items-center p-4 pt-8 pb-20">
                        <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-white animate-fade-in-up">
                            <div className="relative aspect-square bg-slate-200 w-full overflow-hidden flex items-center justify-center group cursor-pointer" onClick={() => setIsImageModalOpen(true)}>
                                {reactionImage ? <img src={reactionImage} className="w-full h-full object-cover transition duration-700 hover:scale-105" /> : <div className="text-center p-6"><IconAlertCircle className="w-12 h-12 text-slate-400 mx-auto mb-2" /><p className="text-slate-500 font-bold">ÁîªÂÉèÁîüÊàêÂ§±Êïó...</p></div>}
                                {reactionImage && <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-black/50 text-white px-4 py-2 rounded-full font-bold pointer-events-none backdrop-blur-sm shadow-lg border border-white/20 flex items-center gap-2"><IconZoomIn className="w-5 h-5" /> Êã°Â§ß</div>}
                                <div className="absolute bottom-4 left-4 bg-black/70 backdrop-blur text-white px-4 py-2 rounded-full font-bold shadow-lg pointer-events-none">È£ü„Åπ„Åü„ÇÇ„ÅÆ: {selectedFood}</div>
                            </div>
                            <div className="p-6 relative">
                                <div className="absolute -top-8 right-6 bg-orange-500 text-white rounded-full p-2 shadow-lg"><span className="text-3xl">{selectedAnimal.icon}</span></div>
                                <h2 className="text-xl font-bold text-orange-600 mb-2">{selectedAnimal.name} „ÅÆÊÑüÊÉ≥</h2>
                                <div className="bg-orange-50 p-4 rounded-2xl border-2 border-orange-100 mb-6 relative">
                                    <div className="absolute left-6 -top-3 w-4 h-4 bg-orange-50 border-t-2 border-l-2 border-orange-100 rotate-45"></div>
                                    <p className="text-lg font-bold text-slate-800 leading-relaxed">{reactionText}</p>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => { playSystemSound('pop'); pickRandomFoods(); setPhase('FEEDING'); setReactionImage(null); }} className="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-xl transition flex items-center justify-center gap-2"><IconRefreshCw className="w-5 h-5" /> „ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
                                    <button onClick={() => { playSystemSound('pop'); setPhase('START'); }} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-md transition">ÈÅï„ÅÜÂãïÁâ©„ÇíÊé¢„Åô</button>
                                </div>
                            </div>
                        </div>
                        {isImageModalOpen && reactionImage && (
                            <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={() => setIsImageModalOpen(false)}>
                                <div className="relative max-w-4xl w-full max-h-[90vh] flex flex-col items-center">
                                    <img src={reactionImage} className="w-full h-full object-contain rounded-lg shadow-2xl" onClick={(e) => e.stopPropagation()} />
                                    <button className="absolute top-4 right-4 text-white bg-white/20 p-2 rounded-full"><IconX className="w-6 h-6"/></button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>