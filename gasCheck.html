<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GASæ¥ç¶šãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result-area {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-height: 200px;
        }

        .result-area h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .result-content {
            background: white;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }

        .image-display {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .image-display img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .url-input {
            margin-bottom: 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¾ GASæ¥ç¶šãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>

        <!-- GAS URLè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“¡ GAS URLè¨­å®š</h2>
            <div class="input-group url-input">
                <label for="gasUrl">GAS Web App URL:</label>
                <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/XXXXX/exec" value="">
            </div>
        </div>

        <!-- æ¥ç¶šãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <p>GASã«æ¥ç¶šã§ãã‚‹ã‹ç¢ºèªã™ã‚‹ã€ŒHello Worldã€ãƒ†ã‚¹ãƒˆã§ã™ã€‚</p>
            <button id="testConnectionBtn" onclick="testConnection()">
                Hello World ãƒ†ã‚¹ãƒˆ
            </button>
            <span id="connectionStatus"></span>
            <div id="connectionResult" class="result-area hidden">
                <h3>æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ</h3>
                <div id="connectionResultContent"></div>
            </div>
        </div>

        <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“¤ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡</h2>
            <div class="input-group">
                <label for="promptInput">é€ä¿¡ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</label>
                <textarea id="promptInput" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">ã‚ãªãŸã¯ã€Œã‚µãƒ«ã€ã¨ã„ã†å‹•ç‰©ã§ã™ã€‚æ€§æ ¼ã¯ã€Œå…ƒæ°—ã§å¥½å¥‡å¿ƒæ—ºç››ã€ã€‚ä»Šã€ŒãƒãƒŠãƒŠã€ã‚’é£Ÿã¹ã¾ã—ãŸã€‚å­ä¾›å‘ã‘ã®å£èª¿ã§ã€60æ–‡å­—ä»¥å†…ã§æ„Ÿæƒ³ã‚’è¨€ã£ã¦ãã ã•ã„ã€‚</textarea>
            </div>
            <div style="margin-top: 10px; padding: 15px; background: #e7f3ff; border-radius: 5px; font-size: 13px; line-height: 1.6;">
                <strong>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä»•æ§˜:</strong><br><br>
                <strong>å…¥åŠ›:</strong> å‹•ç‰©ã®è¡Œå‹•ã‚„çŠ¶æ³ã‚’èª¬æ˜ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ—¥æœ¬èªå¯ï¼‰<br>
                <strong>å‡ºåŠ›:</strong> AIã¯è‡ªå‹•çš„ã«ä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ç­”ã—ã¾ã™ï¼š<br>
                <code style="background: white; padding: 5px; border-radius: 3px; display: block; margin: 5px 0;">{"message": "å‹•ç‰©ã®ã‚»ãƒªãƒ•ï¼ˆæ—¥æœ¬èªï¼‰", "imagePrompt": "ç”»åƒç”Ÿæˆç”¨è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"}</code><br>
                <strong>ç”»åƒç”Ÿæˆ:</strong> imagePromptã®å†…å®¹ã§DALL-E 3ãŒç”»åƒã‚’ç”Ÿæˆã—ã¾ã™<br>
                <strong>ä¾‹:</strong> "A cute cartoon monkey happily eating a banana, Pixar style, white background"<br><br>
                <strong>âš ï¸ æ³¨æ„:</strong> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§ã€Œç”»åƒã‚’ç”Ÿæˆã€ãªã©ã¨æŒ‡ç¤ºã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«å‡¦ç†ã—ã¾ã™ã€‚
            </div>
            <button id="sendPromptBtn" onclick="sendPrompt()">
                ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡
            </button>
            <span id="sendStatus"></span>
        </div>

        <!-- çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“¥ é€å—ä¿¡çµæœ</h2>
            <div id="resultArea" class="result-area">
                <p style="color: #999; text-align: center; padding: 40px;">
                    ã¾ã é€ä¿¡ã—ã¦ã„ã¾ã›ã‚“ã€‚ä¸Šè¨˜ã®ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        // GAS URLã‚’å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
        window.addEventListener('DOMContentLoaded', function() {
            const savedUrl = localStorage.getItem('gasUrl');
            if (savedUrl) {
                document.getElementById('gasUrl').value = savedUrl;
            }
        });

        // GAS URLã‚’ä¿å­˜
        document.getElementById('gasUrl').addEventListener('change', function() {
            localStorage.setItem('gasUrl', this.value);
        });

        /**
         * æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆHello Worldï¼‰
         */
        async function testConnection() {
            const gasUrl = document.getElementById('gasUrl').value;
            const btn = document.getElementById('testConnectionBtn');
            const status = document.getElementById('connectionStatus');
            const resultArea = document.getElementById('connectionResult');
            const resultContent = document.getElementById('connectionResultContent');

            if (!gasUrl) {
                alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            btn.disabled = true;
            status.innerHTML = '<span class="status loading">æ¥ç¶šä¸­...</span><span class="loading-spinner"></span>';
            resultArea.classList.add('hidden');

            const requestBody = ''; // ç©ºã®ãƒœãƒ‡ã‚£ã§Hello Worldãƒ†ã‚¹ãƒˆ
            const requestHeaders = {
                'Content-Type': 'text/plain'
            };

            try {
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: requestHeaders,
                    body: requestBody
                });

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = responseText;
                }
                
                status.innerHTML = '<span class="status success">âœ“ æ¥ç¶šæˆåŠŸ</span>';
                resultArea.classList.remove('hidden');
                
                resultContent.innerHTML = `
                    <div class="result-item">
                        <h4>ğŸ“¤ é€ä¿¡å†…å®¹:</h4>
                        <div class="result-content">${escapeHtml(requestBody === '' ? '(ç©ºã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ - Hello Worldãƒ†ã‚¹ãƒˆ)' : requestBody)}</div>
                    </div>
                    <div class="result-item">
                        <h4>ğŸ“¤ é€ä¿¡ãƒ˜ãƒƒãƒ€ãƒ¼:</h4>
                        <div class="result-content">${escapeHtml(JSON.stringify(requestHeaders, null, 2))}</div>
                    </div>
                    <div class="result-item">
                        <h4>ğŸ“¥ å—ä¿¡å†…å®¹ï¼ˆJSONï¼‰:</h4>
                        <div class="result-content">${escapeHtml(typeof data === 'string' ? data : JSON.stringify(data, null, 2))}</div>
                    </div>
                    <div class="result-item">
                        <h4>ğŸ“¥ å—ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</h4>
                        <div class="result-content">HTTP ${response.status} ${response.statusText}</div>
                    </div>
                `;

            } catch (error) {
                status.innerHTML = '<span class="status error">âœ— æ¥ç¶šå¤±æ•—</span>';
                resultArea.classList.remove('hidden');
                resultContent.innerHTML = `
                    <div class="result-item">
                        <h4>ğŸ“¤ é€ä¿¡å†…å®¹:</h4>
                        <div class="result-content">${escapeHtml(requestBody === '' ? '(ç©ºã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ - Hello Worldãƒ†ã‚¹ãƒˆ)' : requestBody)}</div>
                    </div>
                    <div class="result-item">
                        <h4>ğŸ“¤ é€ä¿¡ãƒ˜ãƒƒãƒ€ãƒ¼:</h4>
                        <div class="result-content">${escapeHtml(JSON.stringify(requestHeaders, null, 2))}</div>
                    </div>
                    <div class="result-item">
                        <h4>âŒ ã‚¨ãƒ©ãƒ¼:</h4>
                        <div class="result-content" style="color: red;">${escapeHtml(error.toString())}</div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
            }
        }

        /**
         * ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡
         */
        async function sendPrompt() {
            const gasUrl = document.getElementById('gasUrl').value;
            const prompt = document.getElementById('promptInput').value;
            const btn = document.getElementById('sendPromptBtn');
            const status = document.getElementById('sendStatus');
            const resultArea = document.getElementById('resultArea');

            if (!gasUrl) {
                alert('GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (!prompt.trim()) {
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            btn.disabled = true;
            status.innerHTML = '<span class="status loading">é€ä¿¡ä¸­...</span><span class="loading-spinner"></span>';

            try {
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: prompt
                });

                const data = await response.json();
                
                status.innerHTML = '<span class="status success">âœ“ é€ä¿¡æˆåŠŸ</span>';
                
                // æ–°ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã«å¯¾å¿œï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‹ç”»åƒï¼‰
                let responseText = '';
                let imageUrl = null;
                let imagePrompt = null;
                let imageError = null;

                // æ–°ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ï¼ˆsuccess, message, imageUrlã‚’å«ã‚€ï¼‰
                if (data.success !== undefined && data.message) {
                    responseText = data.message;
                    imageUrl = data.imageUrl || null;
                    imagePrompt = data.imagePrompt || null;
                    imageError = data.imageError || null;
                } 
                // æ—§å½¢å¼ï¼ˆOpenAI APIå½¢å¼ï¼‰ã¸ã®å¾Œæ–¹äº’æ›æ€§
                else if (data.choices && data.choices[0] && data.choices[0].message) {
                    const text = data.choices[0].message.content;
                    responseText = text;
                    
                    // JSONå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
                    try {
                        const parsedContent = JSON.parse(text);
                        if (parsedContent.message) {
                            responseText = parsedContent.message;
                        }
                    } catch (e) {
                        // JSONã§ãªã„å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤º
                    }
                } 
                // Gemini APIå½¢å¼ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
                else if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const text = data.candidates[0].content.parts[0].text;
                    responseText = text;
                    
                    try {
                        const parsedContent = JSON.parse(text);
                        if (parsedContent.message) {
                            responseText = parsedContent.message;
                        }
                    } catch (e) {
                        // JSONã§ãªã„å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤º
                    }
                } 
                else if (data.message) {
                    responseText = data.message;
                } else {
                    responseText = JSON.stringify(data, null, 2);
                }

                // çµæœã‚’è¡¨ç¤º
                let resultHTML = `
                    <div class="result-item">
                        <h4>ğŸ“¤ é€ä¿¡ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:</h4>
                        <div class="result-content">${escapeHtml(prompt)}</div>
                    </div>
                    <div class="result-item">
                        <h4>ğŸ“¥ å—ä¿¡ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:</h4>
                        <div class="result-content">${escapeHtml(responseText)}</div>
                    </div>
                `;

                // ç”»åƒURLãŒã‚ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤º
                if (imageUrl) {
                    resultHTML += `
                        <div class="result-item">
                            <h4>ğŸ–¼ï¸ DALL-Eã§ç”Ÿæˆã—ãŸç”»åƒ:</h4>
                            <div class="image-display">
                                <img src="${escapeHtml(imageUrl)}" alt="DALL-Eç”Ÿæˆç”»åƒ" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <p style="display:none; color: red;">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
                                <p style="margin-top: 10px;"><strong>ç”»åƒURL:</strong> <a href="${escapeHtml(imageUrl)}" target="_blank">${escapeHtml(imageUrl)}</a></p>
                            </div>
                        </div>
                    `;
                } else if (imageError) {
                    resultHTML += `
                        <div class="result-item">
                            <h4>âŒ ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:</h4>
                            <div class="result-content" style="color: red;">${escapeHtml(imageError)}</div>
                        </div>
                    `;
                }
                
                // ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                if (imagePrompt) {
                    resultHTML += `
                        <div class="result-item">
                            <h4>ğŸ¨ ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</h4>
                            <div class="result-content">${escapeHtml(imagePrompt)}</div>
                        </div>
                    `;
                }
                
                // ç”Ÿã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                resultHTML += `
                    <div class="result-item">
                        <h4>ğŸ“‹ ç”Ÿã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆJSONï¼‰:</h4>
                        <div class="result-content">${escapeHtml(JSON.stringify(data, null, 2))}</div>
                    </div>
                `;

                resultArea.innerHTML = resultHTML;

            } catch (error) {
                status.innerHTML = '<span class="status error">âœ— é€ä¿¡å¤±æ•—</span>';
                resultArea.innerHTML = `
                    <div class="result-item">
                        <h4>ğŸ“¤ é€ä¿¡ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ:</h4>
                        <div class="result-content">${escapeHtml(prompt)}</div>
                    </div>
                    <div class="result-item">
                        <h4>âŒ ã‚¨ãƒ©ãƒ¼:</h4>
                        <div class="result-content" style="color: red;">${escapeHtml(error.toString())}</div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
            }
        }

        /**
         * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
